name: Trigger Scraper Rebuild

on:
  push:
    branches:
      - master
      - main
    # Only trigger on changes to relevant files
    paths:
      - "homeharvest/**"
      - "pyproject.toml"

jobs:
  trigger-railway-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Required to push commits
    steps:
      - name: Trigger Railway Deployment
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}
          RAILWAY_SERVICE_ID: ${{ secrets.RAILWAY_SERVICE_ID }}
        run: |
          echo "üîÑ Triggering Railway deployment for scraper service..."
          echo "   HomeHarvestLocal updated: ${{ github.sha }}"
          echo "   Commit message: ${{ github.event.head_commit.message }}"

          # Validate required secrets
          if [ -z "$RAILWAY_TOKEN" ] || [ -z "$RAILWAY_PROJECT_ID" ] || [ -z "$RAILWAY_SERVICE_ID" ]; then
            echo "‚ö†Ô∏è Railway secrets not fully configured."
            echo "   Required: RAILWAY_TOKEN, RAILWAY_PROJECT_ID, RAILWAY_SERVICE_ID"
            echo "   Missing: $([ -z "$RAILWAY_TOKEN" ] && echo 'RAILWAY_TOKEN ') $([ -z "$RAILWAY_PROJECT_ID" ] && echo 'RAILWAY_PROJECT_ID ') $([ -z "$RAILWAY_SERVICE_ID" ] && echo 'RAILWAY_SERVICE_ID ')"
            exit 1
          fi

          echo "   Using Service ID: $RAILWAY_SERVICE_ID"
          echo "   Using Project ID: $RAILWAY_PROJECT_ID"

          # Method: Create empty commit in scraper repo to trigger Railway
          # Railway watches the git repo, so pushing an empty commit will trigger a deployment
          SCRAPER_REPO="ezraedl/real-estate-crm-scraper"
          BRANCH="main"

          echo "Setting up git..."
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          echo "Cloning scraper repository..."
          # Use SCRAPER_REPO_TOKEN if available (required for cross-repo access)
          # GITHUB_TOKEN only works for the same repo, not cross-repo
          SCRAPER_TOKEN="${{ secrets.SCRAPER_REPO_TOKEN }}"
          if [ -z "$SCRAPER_TOKEN" ]; then
            echo "‚ö†Ô∏è SCRAPER_REPO_TOKEN not set!"
            echo ""
            echo "‚ùå Cannot push to scraper repository without SCRAPER_REPO_TOKEN"
            echo ""
            echo "üìã To fix this, create a GitHub Personal Access Token:"
            echo "   1. Go to: https://github.com/settings/tokens"
            echo "   2. Click 'Generate new token (classic)'"
            echo "   3. Select scope: 'repo' (Full control of private repositories)"
            echo "   4. Generate and copy the token"
            echo "   5. Add it as a secret named 'SCRAPER_REPO_TOKEN' in this repo:"
            echo "      Settings ‚Üí Secrets and variables ‚Üí Actions ‚Üí New repository secret"
            echo ""
            echo "üí° GITHUB_TOKEN cannot write to other repositories."
            echo "   You must use a Personal Access Token for cross-repo access."
            exit 1
          else
            echo "‚úÖ Using SCRAPER_REPO_TOKEN for authentication"
          fi

          git clone "https://x-access-token:${SCRAPER_TOKEN}@github.com/$SCRAPER_REPO.git" scraper-repo || {
            echo "‚ùå Failed to clone scraper repository"
            echo "   Check that SCRAPER_REPO_TOKEN has access to: $SCRAPER_REPO"
            exit 1
          }

          cd scraper-repo

          # Checkout the correct branch
          git checkout $BRANCH || git checkout -b $BRANCH

          # Set remote URL with token for push
          git remote set-url origin "https://x-access-token:${SCRAPER_TOKEN}@github.com/$SCRAPER_REPO.git"

          # Create empty commit to trigger Railway deployment
          echo "Creating empty commit to trigger Railway deployment..."
          git commit --allow-empty -m "chore: trigger rebuild - HomeHarvestLocal updated

          HomeHarvestLocal commit: ${{ github.sha }}
          Triggered by: ${{ github.event.head_commit.message }}
          Workflow: ${{ github.workflow }}
          Run: ${{ github.run_id }}" || {
            echo "‚ö†Ô∏è No changes to commit (this is expected for empty commit)"
          }

          echo "Pushing to trigger Railway deployment..."
          git push origin $BRANCH && {
            echo "‚úÖ Successfully pushed empty commit"
            echo "   Railway should detect the push and start a new deployment"
            echo "   Check your Railway dashboard for deployment status"
          } || {
            echo "‚ùå Failed to push to scraper repository"
            echo "   Check that GITHUB_TOKEN has write permissions"
            exit 1
          }
