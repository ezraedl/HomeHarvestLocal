name: Trigger Scraper Rebuild

on:
  push:
    branches:
      - master
      - main
    # Only trigger on changes to relevant files
    paths:
      - "homeharvest/**"
      - "pyproject.toml"

jobs:
  trigger-railway-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Railway Deployment
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}
          RAILWAY_SERVICE_ID: ${{ secrets.RAILWAY_SERVICE_ID }}
        run: |
          echo "üîÑ Triggering Railway deployment for scraper service..."
          echo "   HomeHarvestLocal updated: ${{ github.sha }}"
          echo "   Commit message: ${{ github.event.head_commit.message }}"

          # Validate required secrets
          if [ -z "$RAILWAY_TOKEN" ] || [ -z "$RAILWAY_PROJECT_ID" ] || [ -z "$RAILWAY_SERVICE_ID" ]; then
            echo "‚ö†Ô∏è Railway secrets not fully configured."
            echo "   Required: RAILWAY_TOKEN, RAILWAY_PROJECT_ID, RAILWAY_SERVICE_ID"
            echo "   Missing: $([ -z "$RAILWAY_TOKEN" ] && echo 'RAILWAY_TOKEN ') $([ -z "$RAILWAY_PROJECT_ID" ] && echo 'RAILWAY_PROJECT_ID ') $([ -z "$RAILWAY_SERVICE_ID" ] && echo 'RAILWAY_SERVICE_ID ')"
            exit 1
          fi

          echo "   Using Service ID: $RAILWAY_SERVICE_ID"
          echo "   Using Project ID: $RAILWAY_PROJECT_ID"

          # Method: Create empty commit in scraper repo to trigger Railway
          # Railway watches the git repo, so pushing an empty commit will trigger a deployment
          SCRAPER_REPO="ezraedl/real-estate-crm-scraper"
          BRANCH="main"

          echo "Setting up git..."
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          echo "Cloning scraper repository..."
          # Use SCRAPER_REPO_TOKEN if available, otherwise use GITHUB_TOKEN
          SCRAPER_TOKEN="${{ secrets.SCRAPER_REPO_TOKEN }}"
          if [ -z "$SCRAPER_TOKEN" ]; then
            echo "SCRAPER_REPO_TOKEN not set, using GITHUB_TOKEN"
            SCRAPER_TOKEN="${{ secrets.GITHUB_TOKEN }}"
          else
            echo "Using SCRAPER_REPO_TOKEN for authentication"
          fi

          git clone "https://x-access-token:${SCRAPER_TOKEN}@github.com/$SCRAPER_REPO.git" scraper-repo || {
            echo "‚ùå Failed to clone scraper repository"
            echo "   If using GITHUB_TOKEN, ensure:"
            echo "   1. The scraper repo is public, OR"
            echo "   2. Both repos are in the same organization, OR"
            echo "   3. Add SCRAPER_REPO_TOKEN secret (GitHub PAT with repo access)"
            exit 1
          }

          cd scraper-repo

          # Checkout the correct branch
          git checkout $BRANCH || git checkout -b $BRANCH

          # Set remote URL with token for push
          git remote set-url origin "https://x-access-token:${SCRAPER_TOKEN}@github.com/$SCRAPER_REPO.git"

          # Create empty commit to trigger Railway deployment
          echo "Creating empty commit to trigger Railway deployment..."
          git commit --allow-empty -m "chore: trigger rebuild - HomeHarvestLocal updated

          HomeHarvestLocal commit: ${{ github.sha }}
          Triggered by: ${{ github.event.head_commit.message }}
          Workflow: ${{ github.workflow }}
          Run: ${{ github.run_id }}" || {
            echo "‚ö†Ô∏è No changes to commit (this is expected for empty commit)"
          }

          echo "Pushing to trigger Railway deployment..."
          git push origin $BRANCH && {
            echo "‚úÖ Successfully pushed empty commit"
            echo "   Railway should detect the push and start a new deployment"
            echo "   Check your Railway dashboard for deployment status"
          } || {
            echo "‚ùå Failed to push to scraper repository"
            echo "   Check that GITHUB_TOKEN has write permissions"
            exit 1
          }
