name: Trigger Scraper Rebuild

on:
  push:
    branches:
      - master
      - main
    # Only trigger on changes to relevant files
    paths:
      - "homeharvest/**"
      - "pyproject.toml"

jobs:
  trigger-railway-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Railway Deployment
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}
          RAILWAY_SERVICE_ID: ${{ secrets.RAILWAY_SERVICE_ID }}
        run: |
          echo "üîÑ Triggering Railway deployment for scraper service..."
          echo "   HomeHarvestLocal updated: ${{ github.sha }}"
          echo "   Commit message: ${{ github.event.head_commit.message }}"

          # Validate required secrets
          if [ -z "$RAILWAY_TOKEN" ] || [ -z "$RAILWAY_PROJECT_ID" ] || [ -z "$RAILWAY_SERVICE_ID" ]; then
            echo "‚ö†Ô∏è Railway secrets not fully configured."
            echo "   Required: RAILWAY_TOKEN, RAILWAY_PROJECT_ID, RAILWAY_SERVICE_ID"
            echo "   Missing: $([ -z "$RAILWAY_TOKEN" ] && echo 'RAILWAY_TOKEN ') $([ -z "$RAILWAY_PROJECT_ID" ] && echo 'RAILWAY_PROJECT_ID ') $([ -z "$RAILWAY_SERVICE_ID" ] && echo 'RAILWAY_SERVICE_ID ')"
            exit 1
          fi

          echo "   Using Service ID: $RAILWAY_SERVICE_ID"
          echo "   Using Project ID: $RAILWAY_PROJECT_ID"

          # Trigger a new deployment via Railway API
          # Railway API v1: POST /v1/services/{serviceId}/deployments
          response=$(curl -s -w "\n%{http_code}" -X POST \
            -H "Authorization: Bearer $RAILWAY_TOKEN" \
            -H "Content-Type: application/json" \
            "https://api.railway.app/v1/services/$RAILWAY_SERVICE_ID/deployments" \
            -d '{
              "environmentId": null
            }') || {
            echo "‚ùå Failed to trigger Railway deployment via API."
            exit 1
          }

          http_code=$(echo "$response" | tail -n1)
          response_body=$(echo "$response" | sed '$d')

          if [ "$http_code" = "200" ] || [ "$http_code" = "201" ]; then
            echo "‚úÖ Successfully triggered Railway deployment (HTTP $http_code)"
            echo "$response_body" | jq '.' 2>/dev/null || echo "$response_body"
          else
            echo "‚ùå Railway API returned status $http_code"
            echo "Response: $response_body"
            echo ""
            echo "Troubleshooting:"
            echo "  1. Verify RAILWAY_TOKEN has deployment permissions"
            echo "  2. Verify RAILWAY_SERVICE_ID is correct"
            echo "  3. Verify RAILWAY_PROJECT_ID is correct"
            echo "  4. Check Railway API documentation for changes"
            exit 1
          fi
