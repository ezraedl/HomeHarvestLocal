name: Trigger Scraper Deployment

on:
  push:
    branches:
      - master
      - main
    paths:
      - 'homeharvest/**'
      - 'pyproject.toml'

jobs:
  trigger-deployment:
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Railway Deployment via API
        env:
          RAILWAY_API_TOKEN: ${{ secrets.RAILWAY_API_TOKEN }}
          RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}
          RAILWAY_SERVICE_ID: ${{ secrets.RAILWAY_SERVICE_ID }}
        run: |
          echo "üîÑ Triggering Railway deployment for scraper service..."
          echo "   HomeHarvestLocal updated at: ${{ github.sha }}"
          
          # Method 1: Use Railway API to trigger deployment
          if [ -n "$RAILWAY_API_TOKEN" ] && [ -n "$RAILWAY_PROJECT_ID" ] && [ -n "$RAILWAY_SERVICE_ID" ]; then
            echo "Using Railway API to trigger deployment..."
            
            # Trigger a new deployment via Railway API
            response=$(curl -s -w "\n%{http_code}" -X POST \
              -H "Authorization: Bearer $RAILWAY_API_TOKEN" \
              -H "Content-Type: application/json" \
              "https://api.railway.app/v1/services/$RAILWAY_SERVICE_ID/deployments" \
              -d '{
                "environmentId": null,
                "variables": {}
              }')
            
            http_code=$(echo "$response" | tail -n1)
            body=$(echo "$response" | sed '$d')
            
            if [ "$http_code" -eq 200 ] || [ "$http_code" -eq 201 ]; then
              echo "‚úÖ Successfully triggered Railway deployment"
              echo "$body" | jq '.' 2>/dev/null || echo "$body"
            else
              echo "‚ùå Failed to trigger Railway deployment (HTTP $http_code)"
              echo "$body"
              exit 1
            fi
          else
            echo "‚ö†Ô∏è Railway credentials not configured."
            echo "   Required secrets: RAILWAY_API_TOKEN, RAILWAY_PROJECT_ID, RAILWAY_SERVICE_ID"
            exit 1
          fi
          
      - name: Create empty commit in scraper repo (Fallback method)
        if: failure()
        env:
          SCRAPER_REPO_TOKEN: ${{ secrets.SCRAPER_REPO_TOKEN }}
          SCRAPER_REPO: ezraedl/real-estate-crm-scraper
        run: |
          echo "Trying fallback method: creating empty commit in scraper repo..."
          
          if [ -z "$SCRAPER_REPO_TOKEN" ]; then
            echo "‚ö†Ô∏è SCRAPER_REPO_TOKEN not set. Skipping fallback method."
            exit 1
          fi
          
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # Clone scraper repo using token
          git clone "https://$SCRAPER_REPO_TOKEN@github.com/$SCRAPER_REPO.git" scraper-repo
          cd scraper-repo
          
          # Create empty commit to trigger Railway (Railway watches for git pushes)
          git commit --allow-empty -m "chore: trigger rebuild - HomeHarvestLocal updated (commit ${{ github.sha }})"
          git push origin main
          
          echo "‚úÖ Empty commit pushed. Railway should detect and deploy."

